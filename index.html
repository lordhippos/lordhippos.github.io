<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>HUE</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- RGB Colour Picker CSS -->
    <link href="https://bgrins.github.io/spectrum/spectrum.css" rel="stylesheet">

    <!--Slider CSS-->
    <link href="css/bootstrap-slider.css" rel="stylesheet" />

    <style media="screen" type="text/css">
        .form-control:disabled {
            background-color: #222222;
            border: 1px solid #111111;
        }

        .sp-replacer {
            margin: 1px;
            padding: 7px;
            border: 1px solid #CCCCCC;
        }

        .sp-disabled {
            background-color: #343a40;
            border: 1px solid #666666!important;
        }
        
        .slider-wide {
            width: 100% !important;
        }

            .slider-wide > .slider-handle {
                position: absolute;
                background-image: -webkit-linear-gradient(top, #FFFFFF 0%, #FFFFFF 100%);
                background-image: -o-linear-gradient(top, #FFFFFF 0%, #FFFFFF 100%);
                background-image: linear-gradient(to bottom, #FFFFFF 0%, #FFFFFF 100%);
            }
    </style>

</head>
<body style="background-color: #222222; padding-top: 60px;" class="text-secondary">
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <div class="col-6">
            <ul class="navbar-nav">
                <a class="navbar-brand" href="#">HUE</a>
            </ul>
        </div>
        <div class="col-6">
            <div class="row">
                <div class="col-3 form-inline">
                    <label class="text-white col-5">Hub IP</label>
                    <input class="form-control col-7" type="text" id="hubIPinput">
                </div>
                <div class="col-7 form-inline">
                    <label class="text-white col-2">User ID</label>
                    <input class="form-control col-10" type="text" id="userIDinput">
                </div>
                <div class="col-2 form-inline">
                    <button type="button" class="btn btn-success btn-block" onclick="genCookie();">Update Cookie</button>
                </div>
            </div>
        </div>
    </nav>
    <div class="container-fluid p-3">

        <div class="row" style="margin: 0px;">

            <div id="templategroups" style="width: 100%;">

            </div>

        </div>
    </div><!-- /.container -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="javascript/spectrum.js"></script>
    <script src="javascript/bootstrap-slider.min.js"></script>

    <script>

        function cie_to_rgb(x, y) {
            var z = 1.0 - x - y;

            var Y = 1.0;
            var X = (Y / y) * x;
            var Z = (Y / y) * z;

            //Convert to RGB using Wide RGB D65 conversion
            var red = X * 1.656492 - Y * 0.354851 - Z * 0.255038;
            var green = -X * 0.707196 + Y * 1.655397 + Z * 0.036152;
            var blue = X * 0.051713 - Y * 0.121364 + Z * 1.011530;

            if (red > blue && red > green && red > 1.0) {
                // red is too big
                green = green / red;
                blue = blue / red;
                red = 1.0;
            }
            else if (green > blue && green > red && green > 1.0) {
                // green is too big
                red = red / green;
                blue = blue / green;
                green = 1.0;
            }
            else if (blue > red && blue > green && blue > 1.0) {
                // blue is too big
                red = red / blue;
                green = green / blue;
                blue = 1.0;
            }

            //Reverse gamma correction
            //red = red <= 0.0031308 ? 12.92 * red : (1.0 + 0.055) * Math.pow(red, (1.0 / 2.4)) - 0.055;
            //green = green <= 0.0031308 ? 12.92 * green : (1.0 + 0.055) * Math.pow(green, (1.0 / 2.4)) - 0.055;
            //blue = blue <= 0.0031308 ? 12.92 * blue : (1.0 + 0.055) * Math.pow(blue, (1.0 / 2.4)) - 0.055;

            if (red > blue && red > green) {
                //red is biggest
                if (red > 1.0)
                {
                    green = green / red;
                    blue = blue / red;
                    red = 1.0;
                }
            }
            else if (green > blue && green > red) {
                // green is biggest
                if (green > 1.0)
                {
                    red = red / green;
                    blue = blue / green;
                    green = 1.0;
                }
            }
            else if (blue > red && blue > green) {
                // blue is biggest
                if (blue > 1.0)
                {
                    red = red / blue;
                    green = green / blue;
                    blue = 1.0;
                }
            }

            //Convert normalized decimal to decimal
            red = Math.round(red * 255);
            green = Math.round(green * 255);
            blue = Math.round(blue * 255);

            return [red, green, blue];
        }

        function rgb_to_cie(r, g, b) {
            //Get the RGB values from your color object and convert them to be between 0 and 1. So the RGB color (255, 0, 100) becomes (1.0, 0.0, 0.39)
            var red = Number((r / 255).toFixed(2));
            var green = Number((g / 255).toFixed(2));
            var blue = Number((b / 255).toFixed(2));

            //Apply a gamma correction to the RGB values, which makes the color more vivid and more the like the color displayed on the screen of your device
            //red = (red > 0.04045) ? Math.pow((red + 0.055) / (1.0 + 0.055), 2.4) : (red / 12.92);
            //green = (green > 0.04045) ? Math.pow((green + 0.055) / (1.0 + 0.055), 2.4) : (green / 12.92);
            //blue = (blue > 0.04045) ? Math.pow((blue + 0.055) / (1.0 + 0.055), 2.4) : (blue / 12.92);

            //RGB values to XYZ using the Wide RGB D65 conversion formula
            var X = red * 0.664511 + green * 0.154324 + blue * 0.162028;
            var Y = red * 0.283881 + green * 0.668433 + blue * 0.047685;
            var Z = red * 0.000088 + green * 0.072310 + blue * 0.986039;

            //Calculate the xy values from the XYZ values
            var x = (X / (X + Y + Z)).toFixed(4);
            var y = (Y / (X + Y + Z)).toFixed(4);

            if (isNaN(x))
                x = 0;

            if (isNaN(y))
                y = 0;

            return [x, y];
        }

        function setCookie(name, value, days) {
            var expires = "";
            if (days) {
                var date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function eraseCookie(name) {
            document.cookie = name + '=; Max-Age=-99999999;';
        }

        function genCookie() {
            var hubIP = document.getElementById('hubIPinput').value;
            var userID = document.getElementById('userIDinput').value;

            setCookie('hue_hub_ip', hubIP, 365);
            setCookie('hue_user_id', userID, 365);

            window.location.reload();
        }

		var hueGroups = [];
		var hueLights = [];
        var hueScenes = [];

        var hubIP = getCookie('hue_hub_ip');
        var userID = getCookie('hue_user_id');

        $("#hubIPinput").val(hubIP);
        $("#userIDinput").val(userID);

		var lightstripSvg = '\
		<svg version="1.2" baseProfile="tiny" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"\
			 x="0px" y="0px" viewBox="-8 0 40 40" xml:space="preserve">\
		<path fill="#FFFFFF" d="M16.6,0H0v5h16.9c0,0,6.1-0.4,7.1,4.7V5.1C24,5.1,24.2,0,16.6,0 M3,3H2V2h1V3z M8,3H7V2h1V3z M13,3h-1V2h1V3\
			z M18,3h-1V2h1V3z M22,4.7L21.3,4L22,3.3L22.7,4L22,4.7z"/>\
		<path fill="#FFFFFF" d="M7.2,19c0,0-6.2,0.4-7.2-4.7v4.6c0,0-0.1,5.1,7.4,5.1H24v-5H7.2z M2,20.7L1.3,20L2,19.3L2.7,20L2,20.7z\
			 M7,22H6v-1h1V22z M12,22h-1v-1h1V22z M17,22h-1v-1h1V22z M22,22h-1v-1h1V22z"/>\
		<path fill="#EEEEEE" d="M5.4,15.4c-1.2,0.4-2,0.7-2.4,1.3c0,0-0.1,0.2-0.1,0.4c0,0,0,0,0,0c-0.2-0.1-0.3-0.2-0.5-0.4\
			c-0.8-0.8-1.4-1.8-1.4-3c0-0.2,0-0.5,0.1-0.8c0.1-0.5,0.3-1,0.5-1.4c0,0,0,0,0,0c2.2-1.8,6.2-1.8,6.2-1.8L13,9.3\
			c2.1-0.2,4.3-0.4,5.6-0.7C20,8.3,20.7,7.7,21,7l0,0c0,0,0,0,0,0c0,0,0,0,0,0c0,0,0.1,0.1,0.3,0.3c1,0.8,1.7,2,1.7,3.4\
			c0,0.1,0,0.3,0,0.4c0,0.4-0.1,0.8-0.3,1.2c0,0,0,0,0,0l0,0c-2.2,2-6.5,2-6.5,2S6.2,15.1,5.4,15.4"/>\
		</svg>'

		var goSvg = '\
		<svg version="1.2" baseProfile="tiny" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"\
			 x="0px" y="0px" viewBox="-8 0 40 40" xml:space="preserve">\
		<path fill="#EEEEEE" d="M4.5,22.8c0.6,0.4,1.5,0.4,2.2-0.1c-1-0.6-2-1.4-2.8-2.2C3.7,21.4,3.9,22.3,4.5,22.8"/>\
		<path fill="#FFFFFF" d="M17.9,7.5c4.4,5.4,6.5,10.9,4.8,12.3c-1.7,1.4-6.7-1.8-11-7.2C7.3,7.2,5.1,1.7,6.9,0.3\
			C8.6-1.1,13.5,2.1,17.9,7.5"/>\
		<path fill="#EEEEEE" d="M10,13.9c-2.2-2.8-4-5.7-5-8.2C4.2,3.7,4,2.1,4.2,1C1.6,3.9-1.6,9.5,3.1,17.8c2,3.3,6.6,6.1,11.6,6.2\
			c2.5,0,4.8-0.7,6.7-1.8C17.9,22.1,13.2,17.9,10,13.9"/>\
		</svg>'

		var bloomSvg = '\
		<svg version="1.2" baseProfile="tiny" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"\
			 x="0px" y="0px" viewBox="-8 0 40 40" xml:space="preserve">\
		<path fill="#EEEEEE" d="M5.8,18.2L5.8,18.2L5.8,18.2c-0.7-0.7-1.3-1.4-1.8-2l-3.8,4.1c0,0-0.5,0.5,0.1,0.7c0.6,0.2,2.5,0.9,7.3,0.6\
			c0.7,0,1.8-0.1,2.3-0.4C8.1,20.2,6.7,19,6,18.4L5.8,18.2z"/>\
		<path fill="#EEEEEE" d="M1.9,5c-0.7,2.9-0.6,7.5,4.6,12.6c1.2,1.1,5,4.6,10.1,5.1c1.8,0.2,2.8,0,4.3-0.6c0,0,0,0,0,0\
			c-3.3-0.4-8.1-3-11.8-6.6C5.2,11.9,2.6,8,1.9,5"/>\
		<path fill="#FFFFFF" d="M17,8.1C11.6,2.9,5.3-0.1,3.4,1.8c-2.1,2,0.8,7.8,6.3,13.1c5.5,5.2,11.9,7.4,13.7,5.8\
			C25.3,18.9,22.5,13.3,17,8.1 M20.3,17.6c-1.3,1.1-5.4-0.5-9.1-4c-3.7-3.6-5.9-7.4-4.5-8.9C7.9,3.5,12.2,5.5,16,9\
			S21.6,16.5,20.3,17.6"/>\
		</svg>'

		var e27Svg = '\
		<svg version="1.2" baseProfile="tiny" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"\
			 x="0px" y="0px" viewBox="-8 0 40 40" xml:space="preserve">\
		<g>\
			<path fill="#EEEEEE" d="M15.016,17.984c0,0,0.953-6.403,1.934-9.972c-1.686,0.442-3.859,0.517-5.109,0.517c-1.875,0-3.637-0.157-4.778-0.409\
				C8.03,11.684,8.984,18,8.984,18S9.121,19,10,19h4C14,19,14.74,18.944,15.016,17.984z"/>\
			<path fill="#FFFFFF" d="M5.817,1.326C4.242,2.329,5.935,5.324,6.674,6.892C6.69,6.928,6.706,6.962,6.721,6.995\
				c1.775,0.625,7.973,0.848,10.629-0.154c0.009-0.018,0.018-0.037,0.027-0.056c0.761-1.594,2.347-4.479,0.806-5.46\
				C16.487,0.246,13.76,0.001,12.013,0h-0.027C10.241,0.001,7.512,0.246,5.817,1.326z"/>\
			<path fill="#EEEEEE" d="M13.011,23C14.031,23,14,22,14,22v-2h-4v2c0,0-0.042,1,0.979,1c0,0,0.002,1.004,1.001,1.004h0.034\
				C13.013,24.004,13.011,23,13.011,23z"/>\
		</g>\
		</svg>'

		function getScenes() {
		    var url = 'http://' + hubIP + '/api/' + userID + '/scenes/';

            $.ajax({
				async: false,
                type: "GET",
                url: url,
                success: function (scenes) {
					hueScenes = scenes;
                },
                cache: true
            });
		}

		function getGroups() {
		    var url = 'http://' + hubIP + '/api/' + userID + '/groups/';

            $.ajax({
				async: false,
                type: "GET",
                url: url,
                success: function (groups) {
					hueGroups = groups;
                },
                cache: true
            });
		}

		function groupLightsOn(groupID) {
		    var url = 'http://' + hubIP + '/api/' + userID + '/groups/' + groupID + '/action/';
			var data = JSON.stringify({ "on": true });

            $.ajax({
				async: false,
                type: "PUT",
				data: data,
                url: url,
                success: function (groupresponse) {
					window.location.reload()
                },
                cache: true
            });
		}

		function groupLightsOff(groupID) {
		    var url = 'http://' + hubIP + '/api/' + userID + '/groups/' + groupID + '/action/';
			var data = JSON.stringify({ "on": false });

            $.ajax({
				async: false,
                type: "PUT",
				data: data,
                url: url,
                success: function (groupresponse) {
					window.location.reload()
                },
                cache: true
            });
		}

		function groupLightsBri(groupID) {
		    var url = 'http://' + hubIP + '/api/' + userID + '/groups/' + groupID + '/action/';
			var newBriInput = 'inputGroupBri' + groupID;
            var lightBri = Number(document.getElementById(newBriInput).innerHTML);
            var convertBri = Math.round((lightBri / 100) * 254);
            var data = JSON.stringify({ "bri": convertBri });

            $.ajax({
				async: false,
                type: "PUT",
				data: data,
                url: url,
                success: function (groupresponse) {
					window.location.reload()
                },
                cache: true
            });
		}

		function groupLightsXy(groupID) {
		    var url = 'http://' + hubIP + '/api/' + userID + '/groups/' + groupID + '/action/';
			var newXyInput = 'inputGroupXy' + groupID;
			var lightXy = document.getElementById(newXyInput).value;
			var Xyarray = lightXy.split(',')

			var data = JSON.stringify({ "xy": [eval(Xyarray[0]),eval(Xyarray[1])] });

            $.ajax({
				async: false,
                type: "PUT",
				data: data,
                url: url,
                success: function (groupresponse) {
					window.location.reload()
                },
                cache: true
            });
		}

		function groupLightsCt(groupID) {
		    var url = 'http://' + hubIP + '/api/' + userID + '/groups/' + groupID + '/action/';
			var newKelvinInput = 'inputGroupCt' + groupID;
            var lightKelvin = Number(document.getElementById(newKelvinInput).innerHTML);
            var lightCt = Math.floor(1000000 / lightKelvin);

            var data = JSON.stringify({ "ct": lightCt });

            $.ajax({
				async: false,
                type: "PUT",
				data: data,
                url: url,
                success: function (groupresponse) {
					window.location.reload()
                },
                cache: true
            });
        }

        function groupScene(groupID, sceneID) {
            var url = 'http://' + hubIP + '/api/' + userID + '/groups/' + groupID + '/action';
            var data = JSON.stringify({ "scene": sceneID });
            
            $.ajax({
                async: false,
                type: "PUT",
                data: data,
                url: url,
                success: function (groupresponse) {
                    window.location.reload()
                },
                cache: true
            });
        };

        function deleteScene(sceneID) {
            var url = 'http://' + hubIP + '/api/' + userID + '/scenes/' + sceneID;

            $.ajax({
                async: false,
                type: "DELETE",
                url: url,
                success: function (groupresponse) {
                    window.location.reload()
                },
                cache: true
            });
        };

        function storeScene(sceneID) {
            var url = 'http://' + hubIP + '/api/' + userID + '/scenes/' + sceneID;
            var data = JSON.stringify({ "storelightstate": true });

            $.ajax({
                async: false,
                type: "PUT",
                data: data,
                url: url,
                success: function (groupresponse) {
                    window.location.reload()
                },
                cache: true
            });
        };

        function createScene(groupID) {
            var url = 'http://' + hubIP + '/api/' + userID + '/scenes/';

            var sceneLights = hueGroups[groupID].lights;
            var sceneName = $("#inputSceneName" + groupID)[0].value;
            var sceneRecycle = $("#inputSceneRecyle" + groupID)[0].checked;

            var data = JSON.stringify({ "name": sceneName, "lights": sceneLights, recycle: sceneRecycle });

            $.ajax({
                async: false,
                type: "POST",
                data: data,
                url: url,
                success: function (groupresponse) {
                    window.location.reload()
                },
                cache: true
            });
        }

		function getLights() {
		    var url = 'http://' + hubIP + '/api/' + userID + '/lights/';

            $.ajax({
				async: false,
                type: "GET",
                url: url,
                success: function (lights) {
					hueLights = lights;
                },
                cache: true
            });
		}

		function pokeLight(lightId) {
		    var url = 'http://' + hubIP + '/api/' + userID + '/lights/' + lightId + '/state/';
			var data = JSON.stringify({ "alert": "select" });

            $.ajax({
                type: "PUT",
                url: url,
				data: data,
                success: function (point) {
                },
                cache: true
            });
		}

		function enableLight(lightId) {
		    var url = 'http://' + hubIP + '/api/' + userID + '/lights/' + lightId + '/state/';
			var data = JSON.stringify({ "on": true });

            $.ajax({
                type: "PUT",
                url: url,
				data: data,
                success: function (point) {
					window.location.reload()
                },
                cache: true
            });
		}

		function disableLight(lightId) {
		    var url = 'http://' + hubIP + '/api/' + userID + '/lights/' + lightId + '/state/';
			var data = JSON.stringify({ "on": false });

            $.ajax({
                type: "PUT",
                url: url,
				data: data,
                success: function (point) {
					window.location.reload()
                },
                cache: true
            });
		}

		function renameLight(lightId) {
		    var url = 'http://' + hubIP + '/api/' + userID + '/lights/' + lightId;
			var newNameInput = 'inputLightName' + lightId
			var lightName = document.getElementById(newNameInput).value;
			var data = JSON.stringify({ "name": lightName });

            $.ajax({
                type: "PUT",
                url: url,
				data: data,
                success: function (point) {
					window.location.reload()
                },
                cache: true
            });
		}

		function briLight(lightId) {
		    var url = 'http://' + hubIP + '/api/' + userID + '/lights/' + lightId + '/state';
			var newBriInput = 'inputLightBri' + lightId
            var lightBri = Number(document.getElementById(newBriInput).innerHTML);
            var convertBri = Math.round((lightBri / 100) * 254);
            var data = JSON.stringify({ "bri": convertBri });

            $.ajax({
                type: "PUT",
                url: url,
				data: data,
                success: function (point) {
					window.location.reload()
                },
                cache: true
            });
		}

		function xyLight(lightId) {
		    var url = 'http://' + hubIP + '/api/' + userID + '/lights/' + lightId + '/state';
			var newXyInput = 'inputLightXy' + lightId
			var lightXy = document.getElementById(newXyInput).value;
			var Xyarray = lightXy.split(',')

			var data = JSON.stringify({ "xy": [eval(Xyarray[0]),eval(Xyarray[1])] });

            $.ajax({
                type: "PUT",
                url: url,
				data: data,
                success: function (point) {
					window.location.reload()
                },
                cache: true
            });
		}

		function ctLight(lightId) {
		    var url = 'http://' + hubIP + '/api/' + userID + '/lights/' + lightId + '/state';
            var newCtInput = 'inputLightCtTest' + lightId;
            var lightKelvin = Number(document.getElementById(newCtInput).innerHTML);
            var lightMired = Math.floor(1000000 / lightKelvin);

            var data = JSON.stringify({ "ct": lightMired });

            $.ajax({
                type: "PUT",
                url: url,
				data: data,
                success: function (point) {
					window.location.reload()
                },
                cache: true
            });
		}

		getGroups();
		getLights();
        getScenes();

        //Loop through Groups
        $.each(hueGroups, function (i, item) {

			var groupLightAllOn = '<span class="material-icons p-0 m-0 align-bottom" style="font-size: 30px;">remove_circle</span>';
			var groupLightAnyon = '<span class="material-icons p-0 m-0 align-bottom" style="font-size: 30px;">remove_circle</span>';
			if (item.state.all_on == true) {groupLightAllOn = '<span class="material-icons p-0 m-0 align-bottom text-success" style="font-size: 30px;">check_circle</span>'};
			if (item.state.any_on == true) {groupLightAnyon = '<span class="material-icons p-0 m-0 align-bottom text-success" style="font-size: 30px;">check_circle</span>'};
			var hueGroupHtml = '\
			<div class="card bg-light mb-3">\
				<div class="card-header">\
					<div class="pr-3 pl-2 d-inline-block">\
						<h3 class="p-0 m-0 display-4" style="font-size: 2.75rem;">' + item.name + '</h3>\
					</div>\
					<div class="pr-3 pl-2 d-inline-block">\
						<h3 class="p-0 m-0">' + i + '</h3>\
						<p class="p-0 text-secondary" style="font-size: 1rem">ID</p>\
					</div>\
					<div class="pr-3 pl-2 d-inline-block">\
						<h3 class="p-0 m-0">' + item.type + '</h3>\
						<p class="p-0 text-secondary" style="font-size: 1rem">Type</p>\
					</div>\
					<div class="pr-3 pl-2 d-inline-block">\
						<h3 class="p-0 m-0">' + item.class + '</h3>\
						<p class="p-0 text-secondary" style="font-size: 1rem">Class</p>\
					</div>\
					<div class="pr-3 pl-2 d-inline-block">\
						<h3 class="p-0 m-0">' + groupLightAllOn + '</h3>\
						<p class="p-0 text-secondary" style="font-size: 1rem">All On</p>\
					</div>\
					<div class="pr-3 pl-2 d-inline-block">\
						<h3 class="p-0 m-0">' + groupLightAnyon + '</h3>\
						<p class="p-0 text-secondary" style="font-size: 1rem">Any On</p>\
					</div>\
				</div>\
				<div class="card-body px-3 pt-3 pb-0" style="background-color: #DDDDDD;">\
					<div class="row mb-3 px-2">\
						<div class="pr-3 pl-1 d-inline-block">\
							  <div class="form-inline">\
							        <button type="button" class="btn btn-success mx-2" onclick="groupLightsOn(' + i + ');"><span style="vertical-align: text-top; line-height: 10px;">All On</span> <span class="material-icons mt-1">add_circle_outline</span></button>\
							        <button type="button" class="btn btn-danger mx-2" onclick="groupLightsOff(' + i + ');"><span style="vertical-align: text-top; line-height: 10px;">All Off</span> <span class="material-icons mt-1">remove_circle_outline</span></button>\
								<div class="form-group">\
								  <label class="mr-3">Brightness</label>\
                                    <input id="briGroupSlider' + i + '" type="text" />\
                                    <span class="ml-3 text-right font-weight-bold" style="min-width: 28px; font-size: 16px;" id="inputGroupBri' + i + '">' + (Math.round((item.action.bri / 254) * 100)) + '</span><span>%</span>\
								   <button type="button" class="btn btn-sm btn-success px-1 py-0 mr-2 ml-1" onclick="groupLightsBri(' + i + ');"><span class="material-icons mt-1">done</span></button>\
								</div>\
								<div class="form-group">\
								  <label>Xy</label>\
								   <input type="text" class="form-control ml-2" id="inputGroupXy' + i + '" form-rounded" value="' + item.action.xy + '">\
								   <input type="text" class="preferredRgb form-control" id="preferredRgb' + i + '" />\
								   <button type="button" class="btn btn-sm btn-success px-1 py-0 mr-2 ml-1" onclick="groupLightsXy(' + i + ');"><span class="material-icons mt-1">done</span></button>\
								</div>\
								<div class="form-group">\
								  <label class="mr-3">Colour Temp</label>\
                                   <input id="ctGroupSlider' + i + '" type="text" />\
								   <span class="ml-3 text-right font-weight-bold" style="min-width: 28px; font-size: 16px;" id="inputGroupCt' + i + '">' + (Math.floor((1000000 / item.action.ct) / 100) * 100) + '</span><span>K</span>\
								   <button type="button" class="btn btn-sm btn-success px-1 py-0 mr-2 ml-1" onclick="groupLightsCt(' + i + ');"><span class="material-icons mt-1">done</span></button>\
								</div>\
							  </div>\
						</div>\
					</div>\
				<div class="card-columns" style="column-count: 2;">'

			$.each(item.lights, function (i, item) {

				var currentLight = hueLights[item];
				var style;
				var State = '<span class="material-icons p-0 m-0 align-bottom" style="font-size: 30px;">remove_circle</span>';
				var Reachable = '<span class="material-icons p-0 m-0 align-bottom" style="font-size: 30px;">check_circle</span>';
				var bulbIcon;
				var bulbName;
                var currentLightHex = '#444444';

				if (currentLight.state.reachable == false) {style += ' text-danger'};
				if (currentLight.state.reachable == false) {Reachable = '<span class="material-icons p-0 m-0 align-bottom" style="font-size: 30px;">remove_circle</span>'};
				if (currentLight.state.on == true) {style = style += ' text-warning'};
				if (currentLight.state.on == true) {State = '<span class="material-icons p-0 m-0 align-bottom" style="font-size: 30px;">check_circle</span>'};

				var XyDisabled = currentLight.state.xy;
				if (XyDisabled === undefined) {XyDisabled = ' disabled'}
				var CtDisabled = currentLight.state.ct;
				if (CtDisabled === undefined) {CtDisabled = ' disabled'}
				var HsDisabled = currentLight.state.hue;
				if (HsDisabled === undefined) {HsDisabled = ' disabled'}

				var XyStyle = 'card bg-dark';
				if (currentLight.state.colormode == 'xy') {XyStyle += ' border-warning'};
				var CtStyle = 'card bg-dark';
				if (currentLight.state.colormode == 'ct') {CtStyle += ' border-warning'};
				var HsStyle = 'card bg-dark';
                if (currentLight.state.colormode == 'hs') { HsStyle += ' border-warning' };

                if (currentLight.state.xy && currentLight.state.colormode == 'xy' && currentLight.state.on == true) {
                    // Light color mode is XY and state is on
					var lightXy = currentLight.state.xy;
					var TestCieToRgb = cie_to_rgb(lightXy[0], lightXy[1]);
					currentLightHex = rgbToHex(TestCieToRgb[0], TestCieToRgb[1], TestCieToRgb[2]);
                }
                else if (currentLight.state.on) {
                    // Light color mode is on but does not support XY
                    var lightCt = currentLight.state.ct;
                    var lightKelvin = (Math.floor((1000000 / lightCt) / 100) * 100);
                    var lightRgb = colorTemperatureToRGB(lightKelvin);
                    currentLightHex = rgbToHex(Math.floor(lightRgb.r), Math.floor(lightRgb.g), Math.floor(lightRgb.b));
                }

				if (currentLight.modelid.match('LCT001|LCT007|LCT010|LCT014')) 	{bulbName = 'Hue Colour'; 		    bulbIcon = e27Svg.replace(/#FFFFFF/g,currentLightHex)};
                if (currentLight.modelid.match('LTW010|LTW001|LTW004|LTW015'))  { bulbName = 'Hue Ambience';        bulbIcon = e27Svg.replace(/#FFFFFF/g,currentLightHex)};
                if (currentLight.modelid.match('LWB004|LWB006'))                { bulbName = 'Hue White';           bulbIcon = e27Svg.replace(/#FFFFFF/g,currentLightHex)};
                if (currentLight.modelid.match('LLC005|LLC011|LLC012|LLC007'))  { bulbName = 'Hue Bloom';           bulbIcon = bloomSvg.replace(/#FFFFFF/g,currentLightHex)};
                if (currentLight.modelid.match('LST001|LST002'))                { bulbName = 'Hue Lightstrip';      bulbIcon = lightstripSvg.replace(/#FFFFFF/g,currentLightHex)};
                if (currentLight.modelid.match('LLC020'))                       { bulbName = 'Hue Go';              bulbIcon = goSvg.replace(/#FFFFFF/g,currentLightHex)};

				hueGroupHtml += '\
				<div class="card bg-dark text-secondary">\
					<div class="card-header h5 p-2 ' + style + '" style="background-color:#222222;">\
						<div class="row">\
							<div class="col-9">\
								<div class="pr-2 pl-2 d-inline-block">\
									<h3 class="p-0 m-0">' + item + '</h3>\
									<p class="p-0 m-0 text-secondary" style="font-size: 1rem">ID</p>\
								</div>\
								<div class="pr-2 pl-2 d-inline-block border-left border-secondary">\
								  <h3 class="p-0 m-0">' + currentLight.name + '</h3>\
								  <p class="p-0 m-0 text-secondary" style="font-size: 1rem">Name</p>\
								</div>\
								<div class="pr-2 pl-2 d-inline-block border-left border-secondary">\
									<h3 class="p-0 m-0">' + (Math.round((currentLight.state.bri / 254) * 100)) + '%</h3>\
									<p class="p-0 m-0 text-secondary" style="font-size: 1rem">Brightness</p>\
								</div>\
								<div class="pr-2 pl-2 d-inline-block border-left border-secondary">\
									<h3 class="p-0 m-0">' + State + '</h3>\
									<p class="p-0 m-0 text-secondary" style="font-size: 1rem">State</p>\
								</div>\
								<div class="pr-2 pl-2 d-inline-block border-left border-secondary">\
									<h3 class="p-0 m-0">' + Reachable + '</h3>\
									<p class="p-0 m-0 text-secondary" style="font-size: 1rem">Reachable</p>\
								</div>\
							</div>\
							<div class="col-3">\
								<div class="text-right py-2">\
									<button type="button" class="btn btn-secondary" onclick="pokeLight(' + item + ');"><span class="material-icons mt-1">search</span></button>\
									<button type="button" class="btn btn-success" onclick="enableLight(' + item + ');"><span class="material-icons mt-1">add_circle_outline</span></button>\
									<button type="button" class="btn btn-danger" onclick="disableLight(' + item + ');"><span class="material-icons mt-1">remove_circle_outline</span></button>\
								</div>\
							</div>\
						</div>\
					</div>\
					<div class="card-body">\
						<div class="row">\
							<div class="col-3">\
								<div class="card text-center" style="border: 0px;">\
								  <div class="card-img-top p-3" style="height: 170px; width: 100%; background-color:#222222;">' + bulbIcon + '</div>\
								  <div class="card-body p-1">\
									<h4 class="card-title mb-1">' + bulbName + ' </h4>\
									<div>Model: ' + currentLight.modelid + '</div>\
									<div>FW: ' + currentLight.swversion + '</div>\
								  </div>\
								</div>\
							</div>\
							<div class="col-9">\
								<div class="row">\
									<div class="col-6">\
										<div class="row">\
											<div class="card bg-dark">\
												<div class="card-body p-3">\
													Name\
													<div class="row">\
														<div class="col-10 pr-0">\
															<input type="text" class="form-control" id="inputLightName' + item + '" form-rounded" value="' + currentLight.name + '">\
														</div>\
														<div class="col-2">\
															<button type="button" class="btn btn-sm btn-success px-1 py-0" onclick="renameLight(' + item + ');"><span class="material-icons mt-1">done</span></button>\
														</div>\
													</div>\
												</div>\
											</div>\
										</div>\
										<div class="row mt-2">\
											<div class="card bg-dark">\
												<div class="card-body p-3">\
													Brightness <span class="ml-1 text-white text-right font-weight-bold" style="min-width: 28px; font-size: 16px;" id="inputLightBri' + item + '">' + (Math.round((currentLight.state.bri / 254) * 100)) + '</span><span class="text-white">%</span>\
													<div class="row">\
														<div class="col-10 pr-0">\
                                                            <input id="briLightSlider' + item + '" type="text" />\
														</div>\
														<div class="col-2">\
															<button type="button" class="btn btn-sm btn-success px-1 py-0" onclick="briLight(' + item + ');"><span class="material-icons mt-1">done</span></button>\
														</div>\
													</div>\
												</div>\
											</div>\
										</div>\
									</div>\
									<div class="col-6">\
										<div class="row mr-1">\
											<div class="' + XyStyle + '">\
												<div class="card-body p-3">\
													Xy\
													<div class="row">\
														<div class="col-8 pr-0">\
															        <input type="text" class="form-control" id="inputLightXy' + item + '" form-rounded" value="' + currentLight.state.xy + '" ' + XyDisabled + '>\
														</div>\
                                                        <div class="col-2 p-0 text-right">\
                                                            <input type="text" class="preferredRgb" id="preferredRgbLight' + item + '" />\
                                                        </div>\
														<div class="col-2">\
															<button type="button" class="btn btn-sm btn-success px-1 py-0" id="clickLightXy' + item + '" onclick="xyLight(' + item + ');"><span class="material-icons mt-1">done</span></button>\
														</div>\
													</div>\
												</div>\
											</div>\
										</div>\
										<div class="row mt-2 mr-1">\
											<div class="' + CtStyle + '">\
												<div class="card-body p-3">\
                                                    <div>\
                                                        Colour Temp <span class="ml-1 text-white text-right font-weight-bold" style="min-width: 28px; font-size: 16px;" id="inputLightCtTest' + item + '">' + (Math.floor((1000000 / currentLight.state.ct) / 100) * 100) + '</span><span class="text-white">K</span>\
                                                    </div>\
													<div class="row">\
														<div class="col-10 pr-0">\
                                                            <input id="ctLightSlider' + item + '" type="text" />\
														</div>\
														<div class="col-2">\
															<button type="button" class="btn btn-sm btn-success px-1 py-0" id="clickLightCt' + item + '" onclick="ctLight(' + item + ');"><span class="material-icons mt-1">done</span></button>\
														</div>\
													</div>\
												</div>\
											</div>\
										</div>\
									</div>\
								</div>\
							</div>\
						</div>\
					</div>\
				</div>'
            });

				hueGroupHtml += '\
				</div>\
                    <form class="form-inline mb-1">\
                    <h3 class="mr-3">Scenes for ' + item.name + '</h3>\
                        <div class="form-group mb-2" >\
                            <label class="mr-2" for="inputSceneName' + i + '">Name</label>\
                            <input type="text" class="form-control" id="inputSceneName' + i + '" placeholder="Scene Name">\
                        </div>\
                        <div class="form-group mb-2">\
                            <label class="mx-2" for="inputSceneRecyle' + i + '">Recycle</label>\
                            <input class="form-check-input" type="checkbox" value="" id="inputSceneRecyle' + i + '" style="width: 18px; height: 18px;" checked>\
                        </div>\
                        <button type="button" class="btn btn-sm btn-success py-0 mb-2 ml-1" onclick="createScene(' + i + ');"><span style="vertical-align: text-top; line-height: 10px; font-size: 16px;">Add Scene</span> <span class="material-icons mt-1">library_add</span></button>\
                        <label class="mb-2 ml-2"><span class="text-danger mr-1" style="font-weight: bold;">Warning!</span> Scenes added here do not appear in the official hue app. Create in the hue app and edit here to workaround this.</label>\
                    </form>\
                <div class>'

                // Used to write Scene table out of at least one scene is exclusive to the group
                var sceneFoundCount = 0;

                // Store all of the scene table data
                var hueSceneRows = '';

                //Loop through Scenes
                $.each(hueScenes, function (SceneCount, Scene) {

                    var sceneExclusive = true;

                    // Loop through Lights in Group
                    $.each(item.lights, function (LightCount, Light) {
                        var lightInGroup = Scene.lights.indexOf(Light);
                        if (lightInGroup == -1) {
                            sceneExclusive = false;
                        }
                    });

                    // Increment Scene Found Count for current group by 1
                    if (sceneExclusive) {
                        sceneFoundCount++

                        var SceneLocked;
                        if (Scene.locked) {
                            SceneLocked = '<i class="material-icons">lock</i>';
                        }
                        else
                        {
                            SceneLocked = '<i class="material-icons">lock_open</i>';
                        };

                        hueSceneRows += '\
                        <tr>\
                            <td>' + Scene.name + '</td>\
                            <td>' + SceneCount + '</td>\
                            <td>' + Scene.lastupdated.replace('T', ' ') + '</td>\
                            <td>[' + Scene.lights + ']</td>\
                            <td>' + SceneLocked + '</td>\
                            <td>\
                            <button type="button" class="btn btn-sm btn-success py-0" onclick="groupScene(' + i + ', \'' + SceneCount + '\');"><span class="material-icons mt-1">play_circle_filled</span></button>\
                            <button type="button" class="btn btn-sm btn-danger py-0" onclick="deleteScene(\'' + SceneCount + '\');"><span class="material-icons mt-1">delete_forever</span></button>\
                            <button type="button" class="btn btn-sm btn-secondary py-0" onclick="storeScene(\'' + SceneCount + '\');"><span class="material-icons mt-1">save</span></button>\
                            </td >\
                        </tr>'
                    };

                });

                if (sceneFoundCount >= 1) {

                    hueGroupHtml += '\
                    <table class="table table-dark" >\
                    <thead>\
                    <tr>\
                        <th scope="col">Name</th>\
                        <th scope="col">ID</th>\
                        <th scope="col">Last Updated</th>\
                        <th scope="col">Lights</th>\
                        <th scope="col">Locked</th>\
                        <th scope="col">Actions</th>\
                    </tr>\
                    </thead>\
                    <tbody>'

                    hueGroupHtml += hueSceneRows;``

                    hueGroupHtml += '\
                    </tbody>\
                    </table>'
                }

                hueGroupHtml += '</div>\
				</div>'

            hueGroupHtml += '\
			</div>'
		$("#templategroups").append($(hueGroupHtml));
        });

        $.each(hueGroups, function (i, item) {

            // Brightness Slider
            $("#briGroupSlider" + i).slider({
                min: 0,
                max: 100,
                step: 5,
                value: $("#inputGroupBri" + i)[0].innerHTML,
                focus: true
            });
            $("#briGroupSlider" + i).on("change", function (changeEvt) {
                $("#inputGroupBri" + i).text(changeEvt.value.newValue);
            });

            //if Group supports Xy Values
            if (item.action.xy) {
                var lightXy = item.action.xy;
                var TestCieToRgb = cie_to_rgb(lightXy[0], lightXy[1]);

                $("#preferredRgb" + i).spectrum({
                    color: "rgb(" + TestCieToRgb[0] + "," + TestCieToRgb[1] + "," + TestCieToRgb[2] + ")",
                    preferredFormat: "rgb",
                    showInput: true,
                    showPalette: true,
                    palette: [["red", "rgba(0, 255, 0, .5)", "rgb(0, 0, 255)"]],
                    change: function (color) {
                        var OutputColour = color.toRgb();
                        var BackToCie = rgb_to_cie(OutputColour.r, OutputColour.g, OutputColour.b);
                        $("#inputGroupXy" + i).val(BackToCie.toString());
                    }
                });
            }
            else {
                $("#preferredRgb" + i).attr('hidden', true);
            };

            //if Group supports Ct Values
            if (item.action.ct) {
                var lightCt = item.action.ct;
                var lightKelvin = (Math.floor((1000000 / lightCt) / 100) * 100);

                // Brightness Slider
                $("#ctGroupSlider" + i).slider({
                    id: ("lightct" + item),
                    min: 2000,
                    max: 6500,
                    step: 100,
                    focus: true,
                    value: lightKelvin
                });
                $("#ctGroupSlider" + i).on("change", function (changeEvt) {
                    $("#inputGroupCt" + i).text(changeEvt.value.newValue);
                });
            };

            $.each(item.lights, function (i, item) {

                var currentLight = hueLights[item];

                // Brightness Slider
                $("#briLightSlider" + item).slider({
                    id: ("light" + item),
                    min: 0,
                    max: 100,
                    step: 5,
                    value: $("#inputLightBri" + item)[0].innerHTML,
                    focus: true
                });

                $("#briLightSlider" + item).on("change", function (changeEvt) {
                    $("#inputLightBri" + item).text(changeEvt.value.newValue);
                });

                if (currentLight.state.xy) {
                    var lightXy = currentLight.state.xy;
                    var TestCieToRgb = cie_to_rgb(lightXy[0], lightXy[1]);

                    $("#preferredRgbLight" + item).spectrum({
                        color: "rgb(" + TestCieToRgb[0] + "," + TestCieToRgb[1] + "," + TestCieToRgb[2] + ")",
                        preferredFormat: "rgb",
                        showInput: true,
                        showPalette: true,
                        palette: [["red", "rgba(0, 255, 0, .5)", "rgb(0, 0, 255)"]],
                        change: function (color) {
                            var OutputColour = color.toRgb();
                            var BackToCie = rgb_to_cie(OutputColour.r, OutputColour.g, OutputColour.b);
                            $("#inputLightXy" + item).val(BackToCie.toString());
                        }
                    });
                }
                else {
                    $("#preferredRgbLight" + item).spectrum({
                        color: "rgba(34, 34, 34, .5)",
                        disabled: true,
                        preferredFormat: "rgb",
                        showInput: true,
                        showPalette: true
                    });
                };

                //Light has colour temp ability
                if (currentLight.state.ct) {

                    var K = (Math.floor((1000000 / currentLight.state.ct) / 100) * 100);

                    // Colour Temp Slider
                    $("#ctLightSlider" + item).slider({
                        id: ("lightct" + item),
                        min: 2000,
                        max: 6500,
                        step: 100,
                        focus: true,
                        value: K
                    });

                    $("#ctLightSlider" + item).on("change", function (changeEvt) {
                        $("#inputLightCtTest" + item).text(changeEvt.value.newValue);
                    });

                }
                //Light does not have colour temp ability
                else {

                    $("#clickLightCt" + item).attr('onclick', 'xyLight(' + item + ')');

                    // Colour Temp Slider
                    $("#ctLightSlider" + item).slider({
                        id: ("lightct" + item),
                        min: 2000,
                        max: 6500,
                        step: 100,
                        focus: true,
                        value: 2000
                    }); 
                };

                $("#ctLightSlider" + item).on("change", function (changeEvt) {
                    var pseudoRgb = colorTemperatureToRGB(changeEvt.value.newValue);
                    var pseudoCie = rgb_to_cie(Math.floor(pseudoRgb.r), Math.floor(pseudoRgb.g), Math.floor(pseudoRgb.b));
                    $("#inputLightXy" + item).val(pseudoCie);
                    $("#inputLightCtTest" + item).text(changeEvt.value.newValue);
                });

                $("#light" + item).addClass('slider-wide');
                $("#lightct" + item).addClass('slider-wide');

            });

        });

		// From https://stackoverflow.com/questions/5623838/rgb-to-hex-and-hex-to-rgb
		function componentToHex(c) {
			var hex = c.toString(16);
			return hex.length == 1 ? "0" + hex : hex;
		}

		function rgbToHex(r, g, b) {
			return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
        }

        function colorTemperatureToRGB(kelvin) {
            var temp = kelvin / 100;
            var red, green, blue;

            if (temp <= 66) {
                red = 255;

                green = temp;
                green = 99.4708025861 * Math.log(green) - 161.1195681661;

                if (temp <= 19) {
                    blue = 0;
                } else {
                    blue = temp - 10;
                    blue = 138.5177312231 * Math.log(blue) - 305.0447927307;
                }
            }
            else {
                red = temp - 60;
                red = 329.698727446 * Math.pow(red, -0.1332047592);

                green = temp - 60;
                green = 288.1221695283 * Math.pow(green, -0.0755148492);

                blue = 255;
            }

            return {
                r: clamp(red, 0, 255),
                g: clamp(green, 0, 255),
                b: clamp(blue, 0, 255)
            }
        }

        function RGBTocolorTemperature(r, g, b) {
            var blue = b + 305.0447927307;
            blue = blue / 138.5177312231;
            blue = Math.exp(blue);
            blue = blue + 10;
            blue = blue * 100;
            blue = Math.round(blue);
            return blue;
        }

        function clamp(x, min, max) {

            if (x < min) { return min; }
            if (x > max) { return max; }

            return x;
        }

    </script>

</body>
</html>